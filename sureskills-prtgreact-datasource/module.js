define(["@grafana/data","lodash","@grafana/runtime","rxjs","react","@grafana/ui"],((e,t,a,r,n,o)=>(()=>{"use strict";var s={781:t=>{t.exports=e},531:e=>{e.exports=a},7:e=>{e.exports=o},241:e=>{e.exports=t},959:e=>{e.exports=n},269:e=>{e.exports=r}},l={};function c(e){var t=l[e];if(void 0!==t)return t.exports;var a=l[e]={exports:{}};return s[e](a,a.exports,c),a.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var a in t)c.o(t,a)&&!c.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};c.r(i),c.d(i,{plugin:()=>F});var u=c(781);const m={Message:"lastmessage",Status:"statustext","Status (Raw)":"statusid"};var d=c(241),f=c.n(d),p=c(531),h=c(269);function g(e,t){return t?("0"+(e+1)).slice(-2):("0"+e).slice(-2)}function v(e,t,a,r,n,o,s){try{var l=e[o](s),c=l.value}catch(e){return void a(e)}l.done?t(c):Promise.resolve(c).then(r,n)}function y(e){return function(){var t=this,a=arguments;return new Promise((function(r,n){var o=e.apply(t,a);function s(e){v(o,r,n,s,l,"next",e)}function l(e){v(o,r,n,s,l,"throw",e)}s(void 0)}))}}const b=e=>{const[t,a]=e.split(" "),[r,n,o]=t.split("/"),[s,l,c]=a.split(":");return`${o}-${n}-${r}T${s}:${l}:${c}.000Z`},w=e=>{const t=new Date(e);return[t.getFullYear(),g(t.getMonth(),!0),g(t.getDate()),g(t.getHours()),g(t.getMinutes()),g(t.getSeconds())].join("-")};class E extends u.DataSourceApi{query(e){var t=this;return y((function*(){const a=e.targets.map((r=y((function*(a){let r=(new Date).toISOString(),n=(o=t.cache_timeout,Date.now()-6e4*o);var o;let s="API Error: ";if(void 0===a.chart_type)return new u.MutableDataFrame({refId:a.refId,fields:[{name:"Time",values:[r],type:u.FieldType.time},{name:"Value",values:[0],type:u.FieldType.number}]});if("Time series"===a.chart_type){let r=[],o=[];const{range:s}=e,l=s.from.valueOf(),c=s.to.valueOf();let i=(e=>{let t=0;const a=e/36e5;return a>12&&a<36?t="300":a>36&&a<745?t="3600":a>745&&(t="86400"),t})(c-l),m="&sdate="+w(l),d="&edate="+w(c);const f=`id=${a.sensor_id}&avg=${i}${m}${d}&usecaption=true`,p=`historicdata.json&id=${a.sensor_id}&avg=${i}&${a.channel_name}`;if(t.cache[p]&&n<t.cache[p].timestamp)r=t.cache[p].dates_array,o=t.cache[p].results_array;else{const e=yield t.directRequest("historicdata.json",f),n=yield e.json();if(n.histdata.length>0){let e=a.channel_name;e.includes("Traffic")&&(e+=" (Speed)"),n.histdata.forEach((function(t){for(const a in t)t.hasOwnProperty(a)&&a.trim()===e&&(o.push(t[a]),r.push(b(t.datetime)))}))}t.cache[p]={results_array:o,dates_array:r,timestamp:Date.now()}}return new u.MutableDataFrame({refId:a.refId,fields:[{name:"Time",values:r,type:u.FieldType.time},{name:a.channel_name,values:o,type:u.FieldType.number}]})}if("Stat"===a.chart_type&&"Text"===a.query_mode){const e=`id=${a.sensor_id}`,o=e+`?filter_property=${a.filter_property}`;let s="N/a";if(t.cache[o]&&n<t.cache[o].timestamp)s=t.cache[o].last_value,r=t.cache[o].datetime;else{const n=yield t.directRequest("getsensordetails.json",e);s=(yield n.json()).sensordata[m[a.filter_property]],t.cache[o]={last_value:s,datetime:r,timestamp:Date.now()}}return new u.MutableDataFrame({refId:a.refId,fields:[{name:"Time",values:[r],type:u.FieldType.time},{name:"Message",values:[s],type:u.FieldType.string}]})}{let e="NaN";const o=`content=channels&columns=name,datetime,lastvalue_&id=${a.sensor_id}`,l=o+`?channel=${a.channel_name}`;if(t.cache[l]&&n<t.cache[l].timestamp)e=t.cache[l].converted_value,r=t.cache[l].datetime;else try{const n=yield t.directRequest("table.json",o),s=yield n.json();if(s.channels.length>0){const n=s.channels.find((e=>e.name===a.channel_name));e=n.lastvalue_raw,r=b(n.datetime),t.cache[l]={converted_value:e,datetime:r,timestamp:Date.now()}}}catch(a){t.cache[l]?(e=t.cache[l].converted_value,r=t.cache[l].datetime,s+=`Using cached values: ${e}`):s+="No cached value, please refresh.",console.log(s)}return new u.MutableDataFrame({refId:a.refId,fields:[{name:"Time",values:[r],type:u.FieldType.time},{name:a.channel_name,values:[e],type:u.FieldType.number}]})}})),function(e){return r.apply(this,arguments)}));var r;return Promise.all(a).then((e=>({data:e})))}))()}request(e,t){var a=this;return y((function*(){const r=(0,p.getBackendSrv)().fetch({url:`${a.base_url}${e}${(null==t?void 0:t.length)?`?${t}`:"?"}&apitoken=${a.api_token}`});return(0,h.lastValueFrom)(r)}))()}directRequest(e,t){var a=this;return y((function*(){const r=(0,h.from)(fetch(`${a.base_url}${e}${(null==t?void 0:t.length)?`?${t}`:"?"}&apitoken=${a.api_token}`));return(0,h.lastValueFrom)(r)}))()}testDatasource(){var e=this;return y((function*(){const t="Cannot connect to API";try{const a=yield e.directRequest("status.json","");return 200===a.status?{status:"success",message:"Success. Version: "+(yield a.json()).Version+" returned from PTRG."}:{status:"error",message:a.statusText?a.statusText:t}}catch(e){let a="";return f().isString(e)?a=e:(0,p.isFetchError)(e)&&(a="Fetch error: "+(e.statusText?e.statusText:t),e.data&&e.data.error&&e.data.error.code&&(a+=": "+e.data.error.code+". "+e.data.error.message)),{status:"error",message:a}}}))()}constructor(e){super(e),this.base_url=e.jsonData.path||"",this.cache_timeout=e.jsonData.cache||5,this.api_token=e.jsonData.api_token||"",this.cache={}}}var _=c(959),j=c.n(_),x=c(7);function N(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function S(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},r=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),r.forEach((function(t){N(e,t,a[t])}))}return e}function O(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t.push.apply(t,a)}return t}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}function P(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function D(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},r=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),r.forEach((function(t){P(e,t,a[t])}))}return e}function T(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t.push.apply(t,a)}return t}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const $=["Metrics","Text","Raw"],I=["Message","Status","Status (Raw)"],k=["Sensor"],F=new u.DataSourcePlugin(E).setConfigEditor((function(e){const{onOptionsChange:t,options:a}=e,[r,n]=(0,_.useState)(a.jsonData.cache||""),[o,s]=(0,_.useState)(""),{jsonData:l,secureJsonFields:c}=a;return j().createElement("div",{className:"gf-form-group"},j().createElement(x.InlineField,{label:"Path",labelWidth:20},j().createElement(x.Input,{onChange:e=>{const r=O(S({},a.jsonData),{path:e.target.value});t(O(S({},a),{jsonData:r}))},value:l.path||"",placeholder:"json field returned to frontend",width:40})),j().createElement(x.InlineField,{label:"API Token",labelWidth:20},j().createElement(x.SecretInput,{value:l.api_token||"",placeholder:"api token",width:40,onChange:e=>{const r=O(S({},a.jsonData),{api_token:e.target.value});t(O(S({},a),{jsonData:r}))}})),j().createElement(x.InlineField,{label:"Cache timeout",labelWidth:20},j().createElement(x.Input,{onKeyPress:e=>{"Enter"===e.key&&e.preventDefault()},onChange:e=>{const r=parseInt(e.target.value,10);if(r>0&&r<=1440){const e=O(S({},a.jsonData),{cache:r});n(r),s(""),t(O(S({},a),{jsonData:e}))}else{const e=O(S({},a.jsonData),{cache:5});n(""),t(O(S({},a),{jsonData:e})),s("Cache timeout should be a number between 1 and 1440. It will default to 5 if not set.")}},value:r,placeholder:"Timeout in minutes",width:40})),j().createElement("div",null,j().createElement("p",{style:{paddingLeft:"165px",paddingTop:"8px",fontSize:"10px",color:"red"},id:"age-error"},o)))})).setQueryEditor((function({query:e,datasource:t,onChange:a,onRunQuery:r}){const n=t.base_url,o="&apitoken="+t.api_token,[s,l]=(0,_.useState)(e.query_mode||$[0]),[c,i]=(0,_.useState)(e.group_name||"*"),[u,m]=(0,_.useState)(e.device_name||"*"),[d,f]=(0,_.useState)(e.sensor_id||0),[p,h]=(0,_.useState)(e.channel_name||"*"),[g,v]=(0,_.useState)(e.filter_property||I[0]),[y,b]=(0,_.useState)(k[0]);let w=document.querySelector('[aria-label="Change Visualization"]').children[1].innerHTML;const E={switch:{paddingLeft:"20px",paddingRight:"30px"},fillPadding:{marginLeft:"15px"},calcButton:{padding:"0px 15px",margin:"0px 15px 4px 15px",borderRadius:"7px",color:"#FFF",border:"none",backgroundColor:"#3781DC"}},[N,S]=(0,_.useState)([""]),[O,P]=(0,_.useState)(!0);(0,_.useEffect)((()=>{fetch(n+"table.json?content=groups&count=9999&columns=objid,group,probe,tags,active,status,message,priority"+o).then((e=>e.json())).then((e=>{if(e.treesize>0){let t=Array.from(new Set(e.groups.map((e=>e.group)).sort()));t.unshift("*"),S(t)}else console.log("No Groups.");P(!1)})).catch((e=>{console.error(`An error occurred: ${e}`)}))}),[]);const[F,q]=(0,_.useState)([""]),[C,R]=(0,_.useState)(!0);(0,_.useEffect)((()=>{let e=n+"table.json?content=devices&count=9999&columns=objid,device,group,probe,tags,active,status,message,priority"+o;"*"!==c&&(e+="&filter_group="+c),fetch(e).then((e=>e.json())).then((e=>{if(e.treesize>0){let t=Array.from(new Set(e.devices.map((e=>e.device)).sort()));t.unshift("*"),q(t)}else"*"!==c?(q(["*"]),console.log("No devices for that group.")):console.log("No Devices.");R(!1)})).catch((e=>{console.error(`An error occurred: ${e}`)}))}),[c]);const[M,L]=(0,_.useState)([""]),[A,V]=(0,_.useState)(!0);(0,_.useEffect)((()=>{let e=n+"table.json?content=sensors&count=9999&columns=objid,sensor,device,group,probe,tags,active,status,message,priority"+o;"*"!==u&&(e+="&filter_device="+u),fetch(e).then((e=>e.json())).then((e=>{if(e.treesize>0){let t=[];e.sensors.forEach((function(e){let a={};a.id=e.objid,a.name=e.sensor,t.push(a)})),t.unshift({id:0,name:"*"}),L(t)}else"*"!==u?(L([{id:0,name:"*"}]),console.log("No sensors for that device.")):console.log("No Sensors.");V(!1)})).catch((e=>{console.error(`An error occurred: ${e}`)}))}),[u]);const[z,G]=(0,_.useState)([""]),[H,Q]=(0,_.useState)(!0);function W(t,n){a(T(D({},e),{query_mode:s,chart_type:w,group_name:c,device_name:u,sensor_id:t,channel_name:"*",filter_property:n})),r()}return(0,_.useEffect)((()=>{let e=n+"table.json?content=channels&output=json&columns=name,datetime,lastvalue_&id=";e+=0!==d?d+"&noraw=1&usecaption=true"+o:"0&noraw=1&usecaption=true"+o,fetch(e).then((e=>e.json())).then((e=>{if(e.channels.length>0){let t=[];e.channels.forEach((function(e){let a={};a.name=e.name,a.last_value=e.lastvalue,t.push(a)})),t.unshift({name:"*"}),G(t)}else 0!==d?(G([{name:"*"}]),console.log("No channels for that sensor.")):console.log("No Channels.");Q(!1)})).catch((e=>{console.error(`An error occurred: ${e}`)}))}),[d]),document.querySelector('[aria-label="Refresh dashboard"]').addEventListener("click",(t=>{a(T(D({},e),{query_mode:s,chart_type:w,group_name:c,device_name:u,sensor_id:parseInt(d),channel_name:p})),r()})),j().createElement("div",null,j().createElement("div",{className:"gf-form-inline"},j().createElement("div",{className:"gf-form max-width-20"},j().createElement("div",{className:"gf-form-label width-7"},"Query Mode"),j().createElement("select",{value:s,onChange:e=>l(e.target.value),className:"gf-form-select-wrapper max-width-20",type:"string"},j().createElement("option",{value:"Metrics",className:"gf-form-input"},"Metrics"),j().createElement("option",{value:"Text",className:"gf-form-input"},"Text"),j().createElement("option",{value:"Raw",className:"gf-form-input",disabled:"true"},"Raw"))),j().createElement("div",{className:"gf-form gf-form--grow",style:E.fillPadding},j().createElement("div",{className:"gf-form-label gf-form-label--grow"}))),"Raw"!==s?j().createElement("div",{className:"gf-form-inline"},j().createElement("div",{className:"gf-form max-width-20"},j().createElement("div",{htmlLabel:"Group",className:"gf-form-label query-keyword width-7"},"Group"),O?j().createElement(x.Input,{type:"text",disabled:!0,placeholder:" Loading groups..."}):j().createElement("select",{value:c,onChange:e=>i(e.target.value),className:"gf-form-select-wrapper max-width-20",type:"string"},N.map((e=>j().createElement("option",{value:e,className:"gf-form-input"},e))))),j().createElement("div",{className:"gf-form max-width-20"},j().createElement("div",{htmlLabel:"Host",className:"gf-form-label query-keyword width-7",style:E.fillPadding},"Host"),C?j().createElement(x.Input,{type:"text",disabled:!0,placeholder:" Loading hosts..."}):j().createElement("select",{value:u,onChange:e=>m(e.target.value),className:"gf-form-select-wrapper max-width-20",type:"string"},F.map((e=>j().createElement("option",{value:e,className:"gf-form-input"},e)))))):j().createElement("div",{className:"gf-form-inline"},j().createElement("div",{className:"gf-form max-width-30"},j().createElement("div",{className:"gf-form-label query-keyword width-7"},"URI"),j().createElement(x.Input,{type:"text",disabled:!0,placeholder:"To be developed...",className:"gf-form-wrapper max-width-25"})),j().createElement("div",{className:"gf-form max-width-30"},j().createElement("div",{className:"gf-form-label query-keyword width-10"},"Query String"),j().createElement(x.Input,{type:"text",disabled:!0,placeholder:"To be developed...",className:"gf-form-wrapper max-width-25"})),j().createElement("div",{className:"gf-form gf-form--grow"},j().createElement("div",{className:"gf-form-label gf-form-label--grow"}))),"Raw"!==s?j().createElement("div",{className:"gf-form-inline"},j().createElement("div",{className:"gf-form max-width-30"},j().createElement("div",{htmlLabel:"Sensor",className:"gf-form-label query-keyword width-7"},"Sensor"),A?j().createElement(x.Input,{type:"text",disabled:!0,placeholder:" Loading sensors..."}):j().createElement("select",{value:d,onChange:e=>{let t=e.target.value;f(t),"Text"===s&&"Stat"==w?W(t,g):console.log("No sensor details required.")},className:"gf-form-select-wrapper max-width-30 sensorValue",type:"string"},M.map((e=>j().createElement("option",{value:e.id,className:"gf-form-input"},e.name))))),"Text"!==s?j().createElement("div",{className:"gf-form max-width-30"},j().createElement("div",{htmlLabel:"Channel",className:"gf-form-label query-keyword width-7",style:E.fillPadding},"Channel"),0!==d?j().createElement("select",{value:p,onChange:t=>{let n=t.target.value;h(n),a(T(D({},e),{query_mode:s,chart_type:w,group_name:c,device_name:u,sensor_id:parseInt(d),channel_name:n})),r()},className:"gf-form-select-wrapper max-width-30",type:"string"},z.map((e=>j().createElement("option",{value:e.name,className:"gf-form-input"},e.name)))):j().createElement(x.Input,{type:"text",disabled:!0,placeholder:H?" Loading channels...":" Sensor must be selected first."})):""):"","Text"===s?j().createElement("div",{className:"gf-form-inline"},j().createElement("div",{className:"gf-form max-width-40"},j().createElement("div",{className:"gf-form-label query-keyword width-7"},"Options")),"Text"===s?j().createElement("div",{className:"gf-form max-width-20"},j().createElement("div",{className:"gf-form-label width-10"},"Value From"),j().createElement("select",{value:y,onChange:e=>b(e.target.value),className:"gf-form-select-wrapper "},k.map((e=>j().createElement("option",{value:e,className:"gf-form-input"},e))))):"","Text"===s?j().createElement("div",{className:"gf-form max-width-20"},j().createElement("div",{className:"gf-form-label width-10"},"Filter Property"),j().createElement("select",{value:g,onChange:e=>{let t=e.target.value;v(t),"Text"===s&&"Stat"==w&&0!==d?W(d,t):console.log("No Get call for sensor")},className:"gf-form-select-wrapper "},I.map((e=>j().createElement("option",{value:e,className:"gf-form-input"},e))))):""):"")}));return i})()));
//# sourceMappingURL=module.js.map